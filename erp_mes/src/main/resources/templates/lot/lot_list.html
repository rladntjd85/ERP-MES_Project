<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">
<head>
<!-- 개별페이지 CSS 영역 -->
<th:block layout:fragment="style">
	<style>
/* 토글 화살표 */
.caret::before {
	content: "\25B6";
	display: inline-block;
	transition: transform .15s ease;
}

a[aria-expanded="true"]>.caret::before {
	transform: rotate(90deg);
}

.card-header {
	min-height: 66px; /* sb-admin-2 기본 header 높이 보통 56px */
}

.card-header input.form-control-sm {
	height: 32px; /* 기본 input-sm 높이 */
	padding: 4px 8px; /* 내부 패딩도 맞춰줌 */
	font-size: 0.875rem;
	line-height: 1.5;
}
</style>

</th:block>
</head>
<body>
	<th:block layout:fragment="content">
		<div class="container-fluid">
			<h1 class="h4 mb-3 text-gray-800">LOT 추적</h1>

			<div class="row align-items-stretch" style="height: 600px;">
				<!-- LOT 계층구조 -->
				<div class="col-lg-6">
					<div class="card shadow mb-4 h-100">
						<div class="card-header py-3 d-flex align-items-center"
							style="min-height: 56px; border-bottom: 1px solid #e3e6f0;">
							<h6 class="m-0 font-weight-bold text-primary">LOT 계층구조</h6>
							<div class="ml-auto">
								<!--보류 <input id="search" class="form-control form-control-sm"
									placeholder="LOT번호 또는 제품코드 검색">-->
							</div>
						</div>
						<div class="card-body" style="height: 56vh; overflow: auto;">
							<ul th:each="lotDTO, stat : ${lotDTOList}" th:object="${lotDTO}"
								class="list-group list-group-flush lotTree" th:id="'lotTree_' + ${stat.index}" >
								<!-- 1뎁스 -->
								<li class="list-group-item p-2">
                                    <a 
                                        data-toggle="collapse"
								        th:href="'#lotA_' + *{workOrderId}"
                                        class="d-flex align-items-center parentList"
                                        aria-expanded="false"
                                        th:aria-controls="'lotA_' + *{workOrderId}"
                                        th:data-value="*{workOrderId}"
                                      > <span
										class="mr-2 caret"></span><span th:text="|*{lotId} *{productName} (*{worOrderStatus})|"></span>
								</a>
									<ul class="collapse pl-4 mt-2" th:id="'lotA_' + *{workOrderId}" th:data-parent="'#lotTree_' + ${stat.index}">
										<!-- 공정 토글 -->
										<li class="list-group-item py-1 px-2 border-0"><a
											data-toggle="collapse" th:href="'#procA_' + *{workOrderId}" th:aria-controls="'procA_' + *{workOrderId}"
											class="d-flex align-items-center childList" data-type="process" th:attr="data-value=*{productId}"> <span
												class="mr-2 caret"></span> 공정</a>
                                                <ul class="collapse pl-3 mt-2" th:id="'procA_' + *{workOrderId}" th:attr="data-parent='#lotA_' + *{workOrderId}">
                                                </ul>
										</li>
										<!-- 자재 토글 -->
										<li class="list-group-item py-1 px-2 border-0"><a
											data-toggle="collapse" th:href="'#matA' + *{workOrderId}" th:aria-controls="'matA' + *{workOrderId}"
											class="d-flex align-items-center childList" data-type="material" th:attr="data-value=*{workOrderId}"> <span
												class="mr-2 caret"></span> 자재
										</a>
											<ul class="collapse pl-3 mt-2" th:id="'matA' + *{workOrderId}" th:attr="data-parent='#lotA_' + *{workOrderId}">

											</ul></li>
										<!-- 설비 토글 (참고로 동일 패턴) -->
										<li class="list-group-item py-1 px-2 border-0"><a
											data-toggle="collapse" th:href="'#eqA' + *{workOrderId}" th:aria-controls="'eqA' + *{workOrderId}"
											class="d-flex align-items-center childList" data-type="equipment" th:attr="data-value=*{productId}"> <span
												class="mr-2 caret"></span> 설비
										</a>
											<ul class="collapse pl-3 mt-2" th:id="'eqA' + *{workOrderId}" th:attr="data-parent='#lotA_' + *{workOrderId}">
											</ul></li>
									</ul></li>
							</ul>
						</div>
					</div>
				</div>

				<!-- LOT 상세 -->
				<div class="col-lg-6">
					<div class="card shadow mb-4 h-100">
						<div class="card-header py-3 d-flex align-items-center"
							style="border-bottom: 1px solid #e3e6f0;">
							<h6 class="m-0 font-weight-bold text-primary flex-grow-1">LOT
								상세</h6>
						</div>
						<div class="card-body">
							<div class="container-fluid px-0">
								<div id="lotDetailRow" class="row">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /.container-fluid -->

	</th:block>

	<th:block layout:fragment="script">
		<script>
        document.addEventListener("DOMContentLoaded", function() {         
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");   
    
    	        // 트리 항목 클릭 이벤트 위임
                /*const lotTrees = document.getElementsByClassName('lotTree');
                Array.from(lotTrees).forEach(function(tree) {
                    tree.addEventListener('click', function(e) {
                        const a = e.target.closest('a.lot-leaf');
                        if (!a) return;
                        e.preventDefault();
                        const data = JSON.parse(a.getAttribute('data-lot'));
                        //bindDetail(data);
                    });
                });
    
    			// 초기 선택(첫 번째 leaf)
    			window.addEventListener('DOMContentLoaded', () => {
    				const first = document.querySelector('#lotTree a.lot-leaf');
    				if (first) first.click();
    			});*/
             
                $(document).on("click", ".parentList", function (e) {
                    e.preventDefault();
                    
                    let workOrderId = $(this).attr('data-value');
                    
                    $.ajax({
                      url: "/lot/getLotDetail/" + workOrderId,
                      method: "POST",
                      contentType: "application/json",
                      beforeSend: function(xhr) {
                          xhr.setRequestHeader(header, token);
                      },
                      success: function (data) {
                        //console.log(data)
                    
                        if (data.length > 0) {
                            // 1) LOT 상세 카드의 .row를 찾음
                             //    가능하면 <div id="lotDetailRow" class="row">로 id를 부여해 정확히 선택
                             const $row = $('#lotDetailRow').length
                               ? $('#lotDetailRow')
                               : $('h6:contains("LOT 상세")').closest('.card').find('.card-body .container-fluid .row').first();
    
                             // 2) .row 안의 첫 번째 .col-6을 타깃으로, 없으면 생성
                             let $col = $row.find('.col-6').first();
                             if ($col.length === 0) {
                               $col = $('<div class="col-6"></div>').appendTo($row);
                             }
    
                             // 3) 기존 내용 제거 후(.empty), 최대 9개 항목 렌더
                             $col.empty();
    
                             const item = Array.isArray(data) && data.length ? data[0] : null;
                             const safe = v => (v === null || v === undefined || v === '') ? '-' : String(v);
    
                             const fields = [
                               { label: '작업자', key: 'empNm' },
                               { label: '제품명', key: 'productNm' },
                               { label: '목표수량', key: 'planQty' },
                               { label: '생산수량', key: 'goodQty' },
                               { label: '불량수량', key: 'defectQty' },
                               { label: '작업시작일', key: 'startDate' },
                               { label: '작업종료일', key: 'endDate' },
                               { label: '작업상태', key: 'workOrderStatus' },
                             ];
    
                             fields.slice(0, 9).forEach(f => {
                               const $mb = $('<div class="mb-3"></div>');
                               $mb.append($('<span class="text-secondary font-weight-bold d-block"></span>').text(f.label));
                               $mb.append($('<span class="font-weight-normal"></span>').text(item ? safe(item[f.key]) : '-'));
                               $col.append($mb);
                             });
                            
                        } else {
                            
                        }
                      }
                    });
                });
                
                // 타입별 엔드포인트 매핑
                const endpointByType = {
                  process:   id => `/lot/getChildren/process/${id}`,
                  material:  id => `/lot/getChildren/material/${id}`,
                  equipment: id => `/lot/getChildren/equipment/${id}`
                };

                // 공용 렌더링: 응답 스키마가 달라도 안전하게 표시
                function renderChildren($ul, data, type) {
                  $ul.empty();

                  if (!Array.isArray(data) || data.length === 0) {
                    // 필요 시 빈 상태 표시
                    // $ul.append('<li class="list-group-item py-1 px-2 border-0 text-muted">데이터 없음</li>');
                    return;
                  }

                  data.forEach(item => {
                    let text = '';
                    let extra = type === 'process'   ? (item.opSeq ? ` (OP:${item.opSeq})` : '') :
                                type === 'material'  ? (item.qty ? ` x${item.qty}` : '') :
                                type === 'equipment' ? (item.status ? ` [${item.status}]` : '') :
                                                      (item.stateNm ? ` [${item.stateNm}]` : '');
    
                    if (type === 'material') {
                      text = `${item.lotId} / ${item.materialId} / ${item.materialName} / ${item.materialType} / ${item.outCount}${extra}`;
                    } else if (type === 'equipment') {
                      text = `${item.equipmentId || item.equipId || '-'} / ${item.equipNm || item.eqpNm || '-'} / ${item.note || '-'}${extra}`;
                    } else {
                      const name = item.proNm || item.name || '-';
                      const typeNm = item.typeNm || type;
                      text = `${name} / ${typeNm}${extra}`;
                    }

                    const $li = $('<li>', {
                      class: 'list-group-item py-1 px-2 border-0',
                      text: text
                    });

                    $ul.append($li);
                  });

                  $ul.collapse('toggle');
                }

                // 공용 클릭 핸들러
                $(document).on("click", ".childList", function (e) {
                  e.preventDefault();

                  const $trigger = $(this);
                  const id   = $trigger.data("value");
                  const type = ($trigger.data("type") || '').toString().toLowerCase();
                  const $ul  = $trigger.next('ul');
                  
                  console.log("id===="+ id)
                  console.log("type===="+ type)
                  
                  if (!id || !type || !endpointByType[type]) {
                    console.warn('Invalid type or id for childList:', type, id);
                    return;
                  }

                  $ul.empty();

                  $.ajax({
                    url: endpointByType[type](id),
                    method: "POST",
                    contentType: "application/json",
                    beforeSend: function(xhr) {
                      xhr.setRequestHeader(header, token);
                    },
                    success: function (data) {
                       console.log(data)
                      renderChildren($ul, data, type);
                    },
                    error: function (xhr) {
                      console.error('Load children failed:', xhr);
                      // 필요 시 오류 표시
                      // $ul.append('<li class="list-group-item py-1 px-2 border-0 text-danger">로드 실패</li>');
                    }
                  });
                });
            });
	</script>
	</th:block>
</body>
</html>
