version: '3.8'

services:
  spring:
    image: myapp
    container_name: spring
    restart: unless-stopped
    networks:
      - mynetwork
    ports:
      - "8080:8080"
    volumes:
      - /home/ubuntu/upload:/upload
      - /home/ubuntu/personnel/img:/personnel/img
    environment:
      DB_URL: ${DB_URL}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SERVICE_KEY: ${SERVICE_KEY}
      DATA_GO_KR_API_KEY: ${DATA_GO_KR_API_KEY}
      # JVM이 컨테이너 메모리를 제대로 인식하도록 강제
      JAVA_OPTS: >-
        -XX:MaxRAMPercentage=75.0
        -XX:InitialRAMPercentage=50.0
        -XX:+UseG1GC
        -Xss512k
        -XX:+ExitOnOutOfMemoryError
    mem_limit: 768m                  # spring 컨테이너 최대 768MB
    mem_reservation: 512m            # 최소 보장 512MB
    deploy:
      resources:
        limits:
          memory: 768m
        reservations:
          memory: 512m

  nginx:
    image: nginx:latest
    container_name: nginx
    restart: always
    networks:
      - mynetwork
    depends_on:
      - spring
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - /etc/letsencrypt:/etc/letsencrypt  # SSL 사용 시
      - /var/lib/letsencrypt:/var/lib/letsencrypt
      mem_limit: 256m                  # nginx는 가볍게 충분
      mem_reservation: 128m
  
  oracle-xe:                         # oracle 서비스가 compose에 없었지만 stats에 있으니 추가 추천
    image: gvenzl/oracle-xe:21-slim   # 공식 slim 버전 추천 (기존이 full이면 더 무거움)
    container_name: oracle-xe
    restart: unless-stopped
    networks:
      - mynetwork
    environment:
      ORACLE_PASSWORD: your_password  # 필요시
    volumes:
      - oracle-data:/opt/oracle/oradata
    mem_limit: 1500m                 # Oracle XE 최대 1.5GB 제한
    mem_reservation: 1024m

volumes:
  oracle-data:                       # oracle 데이터 영속화

networks:
  mynetwork:
    external: true
